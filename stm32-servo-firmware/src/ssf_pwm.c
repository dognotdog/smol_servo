

#include <stdint.h>

#include <math.h>
#include <main.h>
#include <ssf_main.h>
#include <debug.h>


/**

Mechaduino stepper have ca. 1.2OR resistance, thus a 10% duty cycle would mean roughly 1A of current.

PWMing a 2 phase stepper. UVW corresponds to ABC drivers

 U
 |                 -
 3				 /   \           
 3	Winding A	.	   \       /
 3						 \   /
 |						   -
 V
 |				.              -
 3				 \           /   
 3	Winding B	   \   	   /	
 3					 \	 / 
 |					   -
 W

 A = sin(x)
 B = sin(x+90deg)
 A + B = sqrt(2)*sin(x+45deg)

 V would need to rise and fall, to optimally use available voltage. If V is kept at 50%, effective voltage is available to either phase is only 1/2 of bus voltage, when with a 90deg phase shifted sine waves sqrt(3) would be optimal

 U   W
 |   |
 3   3
 3   3
 3   3
 |   |
 '-*-'
   |
   V

*/


#define DRV_PWM_DITHER	(16)
#define DRV_PWM_PERIOD	(1700*DRV_PWM_DITHER)
#define DRV_PWM_MAX		(DRV_PWM_PERIOD - DRV_PWM_DITHER)
// #define DRV_PWM_PERIOD	(850*DRV_PWM_DITHER)

#define DRV_PWM_MOT_MAX		(DRV_PWM_PERIOD-DRV_PWM_DITHER)
#define DRV_PWM_MOT_MIN		0
#define DRV_PWM_BRK_MAX		(DRV_PWM_PERIOD-DRV_PWM_DITHER)
#define DRV_PWM_BRK_MIN		0

// #define DRV_PWM_MOT_MAX		(DRV_PWM_PERIOD-DRV_PWM_DITHER)*(0.5f+0.2f)
// #define DRV_PWM_MOT_MIN		(DRV_PWM_PERIOD-DRV_PWM_DITHER)*(0.5f-0.2f)
// #define DRV_PWM_BRK_MAX		(DRV_PWM_PERIOD-DRV_PWM_DITHER)*(0.1f)
// #define DRV_PWM_BRK_MIN		(DRV_PWM_PERIOD-DRV_PWM_DITHER)*(0.0f)

#define SINTAB_COUNT	32

#if SINTAB_COUNT == 32
static float _sintab[SINTAB_COUNT] = {
	0.00000000000000e+00f,9.80171403295606e-02f,1.95090322016128e-01f,2.90284677254462e-01f,3.82683432365090e-01f,4.71396736825998e-01f,5.55570233019602e-01f,6.34393284163645e-01f,7.07106781186547e-01f,7.73010453362737e-01f,8.31469612302545e-01f,8.81921264348355e-01f,9.23879532511287e-01f,9.56940335732209e-01f,9.80785280403230e-01f,9.95184726672197e-01f,1.00000000000000e+00f,9.95184726672197e-01f,9.80785280403230e-01f,9.56940335732209e-01f,9.23879532511287e-01f,8.81921264348355e-01f,8.31469612302545e-01f,7.73010453362737e-01f,7.07106781186548e-01f,6.34393284163645e-01f,5.55570233019603e-01f,4.71396736825998e-01f,3.82683432365090e-01f,2.90284677254462e-01f,1.95090322016129e-01f,9.80171403295608e-02f
};
#elif SINTAB_COUNT == 64
static float _sintab[SINTAB_COUNT] = {
	0.00000000000000e+00f,4.90676743274180e-02f,9.80171403295606e-02f,1.46730474455362e-01f,1.95090322016128e-01f,2.42980179903264e-01f,2.90284677254462e-01f,3.36889853392220e-01f,3.82683432365090e-01f,4.27555093430282e-01f,4.71396736825998e-01f,5.14102744193222e-01f,5.55570233019602e-01f,5.95699304492433e-01f,6.34393284163645e-01f,6.71558954847018e-01f,7.07106781186547e-01f,7.40951125354959e-01f,7.73010453362737e-01f,8.03207531480645e-01f,8.31469612302545e-01f,8.57728610000272e-01f,8.81921264348355e-01f,9.03989293123443e-01f,9.23879532511287e-01f,9.41544065183021e-01f,9.56940335732209e-01f,9.70031253194544e-01f,9.80785280403230e-01f,9.89176509964781e-01f,9.95184726672197e-01f,9.98795456205172e-01f,1.00000000000000e+00f,9.98795456205172e-01f,9.95184726672197e-01f,9.89176509964781e-01f,9.80785280403230e-01f,9.70031253194544e-01f,9.56940335732209e-01f,9.41544065183021e-01f,9.23879532511287e-01f,9.03989293123443e-01f,8.81921264348355e-01f,8.57728610000272e-01f,8.31469612302545e-01f,8.03207531480645e-01f,7.73010453362737e-01f,7.40951125354959e-01f,7.07106781186548e-01f,6.71558954847018e-01f,6.34393284163645e-01f,5.95699304492433e-01f,5.55570233019602e-01f,5.14102744193222e-01f,4.71396736825997e-01f,4.27555093430282e-01f,3.82683432365090e-01f,3.36889853392220e-01f,2.90284677254462e-01f,2.42980179903264e-01f,1.95090322016128e-01f,1.46730474455362e-01f,9.80171403295604e-02f,4.90676743274180e-02f
};
#elif SINTAB_COUNT == 128
static float _sintab[SINTAB_COUNT] = {
	0.00000000000000e+00f,2.45412285229123e-02f,4.90676743274180e-02f,7.35645635996674e-02f,9.80171403295606e-02f,1.22410675199216e-01f,1.46730474455362e-01f,1.70961888760301e-01f,1.95090322016128e-01f,2.19101240156870e-01f,2.42980179903264e-01f,2.66712757474898e-01f,2.90284677254462e-01f,3.13681740398892e-01f,3.36889853392220e-01f,3.59895036534988e-01f,3.82683432365090e-01f,4.05241314004990e-01f,4.27555093430282e-01f,4.49611329654607e-01f,4.71396736825998e-01f,4.92898192229784e-01f,5.14102744193222e-01f,5.34997619887097e-01f,5.55570233019602e-01f,5.75808191417845e-01f,5.95699304492433e-01f,6.15231590580627e-01f,6.34393284163645e-01f,6.53172842953777e-01f,6.71558954847018e-01f,6.89540544737067e-01f,7.07106781186547e-01f,7.24247082951467e-01f,7.40951125354959e-01f,7.57208846506485e-01f,7.73010453362737e-01f,7.88346427626606e-01f,8.03207531480645e-01f,8.17584813151584e-01f,8.31469612302545e-01f,8.44853565249707e-01f,8.57728610000272e-01f,8.70086991108711e-01f,8.81921264348355e-01f,8.93224301195515e-01f,9.03989293123443e-01f,9.14209755703531e-01f,9.23879532511287e-01f,9.32992798834739e-01f,9.41544065183021e-01f,9.49528180593037e-01f,9.56940335732209e-01f,9.63776065795440e-01f,9.70031253194544e-01f,9.75702130038529e-01f,9.80785280403230e-01f,9.85277642388941e-01f,9.89176509964781e-01f,9.92479534598710e-01f,9.95184726672197e-01f,9.97290456678690e-01f,9.98795456205172e-01f,9.99698818696204e-01f,1.00000000000000e+00f,9.99698818696204e-01f,9.98795456205172e-01f,9.97290456678690e-01f,9.95184726672197e-01f,9.92479534598710e-01f,9.89176509964781e-01f,9.85277642388941e-01f,9.80785280403230e-01f,9.75702130038529e-01f,9.70031253194544e-01f,9.63776065795440e-01f,9.56940335732209e-01f,9.49528180593037e-01f,9.41544065183021e-01f,9.32992798834739e-01f,9.23879532511287e-01f,9.14209755703531e-01f,9.03989293123443e-01f,8.93224301195515e-01f,8.81921264348355e-01f,8.70086991108711e-01f,8.57728610000272e-01f,8.44853565249707e-01f,8.31469612302545e-01f,8.17584813151584e-01f,8.03207531480645e-01f,7.88346427626606e-01f,7.73010453362737e-01f,7.57208846506484e-01f,7.40951125354959e-01f,7.24247082951467e-01f,7.07106781186548e-01f,6.89540544737067e-01f,6.71558954847018e-01f,6.53172842953777e-01f,6.34393284163645e-01f,6.15231590580627e-01f,5.95699304492433e-01f,5.75808191417845e-01f,5.55570233019602e-01f,5.34997619887097e-01f,5.14102744193222e-01f,4.92898192229784e-01f,4.71396736825998e-01f,4.49611329654606e-01f,4.27555093430282e-01f,4.05241314004990e-01f,3.82683432365090e-01f,3.59895036534988e-01f,3.36889853392220e-01f,3.13681740398891e-01f,2.90284677254462e-01f,2.66712757474898e-01f,2.42980179903264e-01f,2.19101240156870e-01f,1.95090322016128e-01f,1.70961888760301e-01f,1.46730474455362e-01f,1.22410675199216e-01f,9.80171403295608e-02f,7.35645635996673e-02f,4.90676743274180e-02f,2.45412285229123e-02f
};
#elif SINTAB_COUNT == 256
static float _sintab[SINTAB_COUNT] = {
	0.00000000000000e+00f,1.22715382857199e-02f,2.45412285229123e-02f,3.68072229413588e-02f,4.90676743274180e-02f,6.13207363022086e-02f,7.35645635996674e-02f,8.57973123444399e-02f,9.80171403295606e-02f,1.10222207293883e-01f,1.22410675199216e-01f,1.34580708507126e-01f,1.46730474455362e-01f,1.58858143333861e-01f,1.70961888760301e-01f,1.83039887955141e-01f,1.95090322016128e-01f,2.07111376192219e-01f,2.19101240156870e-01f,2.31058108280671e-01f,2.42980179903264e-01f,2.54865659604515e-01f,2.66712757474898e-01f,2.78519689385053e-01f,2.90284677254462e-01f,3.02005949319228e-01f,3.13681740398892e-01f,3.25310292162263e-01f,3.36889853392220e-01f,3.48418680249435e-01f,3.59895036534988e-01f,3.71317193951837e-01f,3.82683432365090e-01f,3.93992040061048e-01f,4.05241314004990e-01f,4.16429560097637e-01f,4.27555093430282e-01f,4.38616238538528e-01f,4.49611329654607e-01f,4.60538710958240e-01f,4.71396736825998e-01f,4.82183772079123e-01f,4.92898192229784e-01f,5.03538383725718e-01f,5.14102744193222e-01f,5.24589682678469e-01f,5.34997619887097e-01f,5.45324988422046e-01f,5.55570233019602e-01f,5.65731810783613e-01f,5.75808191417845e-01f,5.85797857456439e-01f,5.95699304492433e-01f,6.05511041404326e-01f,6.15231590580627e-01f,6.24859488142386e-01f,6.34393284163645e-01f,6.43831542889791e-01f,6.53172842953777e-01f,6.62415777590172e-01f,6.71558954847018e-01f,6.80600997795453e-01f,6.89540544737067e-01f,6.98376249408973e-01f,7.07106781186547e-01f,7.15730825283819e-01f,7.24247082951467e-01f,7.32654271672413e-01f,7.40951125354959e-01f,7.49136394523459e-01f,7.57208846506485e-01f,7.65167265622459e-01f,7.73010453362737e-01f,7.80737228572094e-01f,7.88346427626606e-01f,7.95836904608883e-01f,8.03207531480645e-01f,8.10457198252595e-01f,8.17584813151584e-01f,8.24589302785025e-01f,8.31469612302545e-01f,8.38224705554838e-01f,8.44853565249707e-01f,8.51355193105265e-01f,8.57728610000272e-01f,8.63972856121587e-01f,8.70086991108711e-01f,8.76070094195407e-01f,8.81921264348355e-01f,8.87639620402854e-01f,8.93224301195515e-01f,8.98674465693954e-01f,9.03989293123443e-01f,9.09167983090522e-01f,9.14209755703531e-01f,9.19113851690058e-01f,9.23879532511287e-01f,9.28506080473216e-01f,9.32992798834739e-01f,9.37339011912575e-01f,9.41544065183021e-01f,9.45607325380521e-01f,9.49528180593037e-01f,9.53306040354194e-01f,9.56940335732209e-01f,9.60430519415566e-01f,9.63776065795440e-01f,9.66976471044852e-01f,9.70031253194544e-01f,9.72939952205560e-01f,9.75702130038529e-01f,9.78317370719628e-01f,9.80785280403230e-01f,9.83105487431216e-01f,9.85277642388941e-01f,9.87301418157858e-01f,9.89176509964781e-01f,9.90902635427780e-01f,9.92479534598710e-01f,9.93906970002356e-01f,9.95184726672197e-01f,9.96312612182778e-01f,9.97290456678690e-01f,9.98118112900149e-01f,9.98795456205172e-01f,9.99322384588350e-01f,9.99698818696204e-01f,9.99924701839145e-01f,1.00000000000000e+00f,9.99924701839145e-01f,9.99698818696204e-01f,9.99322384588350e-01f,9.98795456205172e-01f,9.98118112900149e-01f,9.97290456678690e-01f,9.96312612182778e-01f,9.95184726672197e-01f,9.93906970002356e-01f,9.92479534598710e-01f,9.90902635427780e-01f,9.89176509964781e-01f,9.87301418157858e-01f,9.85277642388941e-01f,9.83105487431216e-01f,9.80785280403230e-01f,9.78317370719628e-01f,9.75702130038529e-01f,9.72939952205560e-01f,9.70031253194544e-01f,9.66976471044852e-01f,9.63776065795440e-01f,9.60430519415566e-01f,9.56940335732209e-01f,9.53306040354194e-01f,9.49528180593037e-01f,9.45607325380521e-01f,9.41544065183021e-01f,9.37339011912575e-01f,9.32992798834739e-01f,9.28506080473216e-01f,9.23879532511287e-01f,9.19113851690058e-01f,9.14209755703531e-01f,9.09167983090522e-01f,9.03989293123443e-01f,8.98674465693954e-01f,8.93224301195515e-01f,8.87639620402854e-01f,8.81921264348355e-01f,8.76070094195407e-01f,8.70086991108711e-01f,8.63972856121587e-01f,8.57728610000272e-01f,8.51355193105265e-01f,8.44853565249707e-01f,8.38224705554838e-01f,8.31469612302545e-01f,8.24589302785025e-01f,8.17584813151584e-01f,8.10457198252595e-01f,8.03207531480645e-01f,7.95836904608884e-01f,7.88346427626606e-01f,7.80737228572095e-01f,7.73010453362737e-01f,7.65167265622459e-01f,7.57208846506484e-01f,7.49136394523459e-01f,7.40951125354959e-01f,7.32654271672413e-01f,7.24247082951467e-01f,7.15730825283819e-01f,7.07106781186548e-01f,6.98376249408973e-01f,6.89540544737067e-01f,6.80600997795453e-01f,6.71558954847019e-01f,6.62415777590172e-01f,6.53172842953777e-01f,6.43831542889791e-01f,6.34393284163645e-01f,6.24859488142386e-01f,6.15231590580627e-01f,6.05511041404326e-01f,5.95699304492433e-01f,5.85797857456439e-01f,5.75808191417845e-01f,5.65731810783613e-01f,5.55570233019602e-01f,5.45324988422046e-01f,5.34997619887097e-01f,5.24589682678469e-01f,5.14102744193222e-01f,5.03538383725718e-01f,4.92898192229784e-01f,4.82183772079123e-01f,4.71396736825998e-01f,4.60538710958240e-01f,4.49611329654606e-01f,4.38616238538528e-01f,4.27555093430282e-01f,4.16429560097637e-01f,4.05241314004990e-01f,3.93992040061048e-01f,3.82683432365090e-01f,3.71317193951838e-01f,3.59895036534988e-01f,3.48418680249435e-01f,3.36889853392220e-01f,3.25310292162263e-01f,3.13681740398891e-01f,3.02005949319228e-01f,2.90284677254462e-01f,2.78519689385053e-01f,2.66712757474898e-01f,2.54865659604515e-01f,2.42980179903264e-01f,2.31058108280671e-01f,2.19101240156870e-01f,2.07111376192219e-01f,1.95090322016128e-01f,1.83039887955141e-01f,1.70961888760301e-01f,1.58858143333861e-01f,1.46730474455362e-01f,1.34580708507126e-01f,1.22410675199216e-01f,1.10222207293883e-01f,9.80171403295608e-02f,8.57973123444402e-02f,7.35645635996673e-02f,6.13207363022085e-02f,4.90676743274180e-02f,3.68072229413588e-02f,2.45412285229123e-02f,1.22715382857200e-02f
};

#else
	#error SINTAB_COUNT needs to be defined to one of: 32,64,128,256
#endif


// normalized input fixed point sine lookup
float sintab(float x)
{
	float x2pi = fmodf(x, 2.0f*M_PI);

	// gemerate lookup integer and fractional parts
	// our tables contain half a sine wave

	// convert to table index range, in float first, adding 2pi to ensure always positive
	float xtab = (x2pi+2.0f*M_PI)*(SINTAB_COUNT/M_PI);
	uint32_t xint = ((unsigned) xtab) % (2*SINTAB_COUNT);
	float xfrac0  = fmodf(xtab, 1.0f);
	float xfrac1 = 1.0f-xfrac0;



	float y0 = _sintab[xint     % SINTAB_COUNT];
	float y1 = _sintab[(xint+1) % SINTAB_COUNT];

	// perform interpolation
	float yabs = y0*xfrac1 + y1*xfrac0;

	// return value with proper sign
	return xint < SINTAB_COUNT ? yabs : -yabs;
}

void spwm_enableHalfBridges(uint32_t outputMask)
{
	HAL_GPIO_WritePin(PIN_ENA, (outputMask >> 0) & 0x1);
	HAL_GPIO_WritePin(PIN_ENB, (outputMask >> 1) & 0x1);
	HAL_GPIO_WritePin(PIN_ENC, (outputMask >> 2) & 0x1);

}

void spwm_startRealtime(void)
{
	HAL_TIM_Base_Stop(HTIM_DRV);
	HAL_TIM_Base_Stop(HTIM_ISENSE_OFFSET);

	// setup triggered ADC offset timer
	__HAL_TIM_SET_AUTORELOAD(HTIM_ISENSE_OFFSET, 1699);
	__HAL_TIM_SET_COMPARE(HTIM_ISENSE_OFFSET, TIM_CHANNEL_1, 1699 - ISENSE_SSAA_CPU_CYCLES/2);

	HAL_TIM_Base_Start(HTIM_ISENSE_OFFSET);

	// with dithering, subtract 16
	__HAL_TIM_SET_AUTORELOAD(HTIM_DRV, (DRV_PWM_PERIOD - DRV_PWM_DITHER));

	__HAL_TIM_SET_COMPARE(HTIM_DRV, HTIM_DRV_CH_R, 0);
	__HAL_TIM_SET_COMPARE(HTIM_DRV, HTIM_DRV_CH_A, 0);
	__HAL_TIM_SET_COMPARE(HTIM_DRV, HTIM_DRV_CH_B, 0);
	__HAL_TIM_SET_COMPARE(HTIM_DRV, HTIM_DRV_CH_C, 0);

	HAL_TIM_Base_Start(HTIM_DRV);

	HAL_TIM_PWM_Start(HTIM_DRV, HTIM_DRV_CH_R);  
	HAL_TIM_PWM_Start(HTIM_DRV, HTIM_DRV_CH_A);  
	HAL_TIM_PWM_Start(HTIM_DRV, HTIM_DRV_CH_B);  
	HAL_TIM_PWM_Start(HTIM_DRV, HTIM_DRV_CH_C);  

}

void spwm_stopRealtime(void)
{
	// turn off power to the motor
	spwm_enableHalfBridges(0x0);

	// stop the realtime relevant timers
	HAL_TIM_Base_Stop(HTIM_DRV);
	HAL_TIM_Base_Stop(HTIM_ISENSE_OFFSET);
}

void spwm_init(void)
{
	HAL_GPIO_WritePin(PIN_DRVEN, GPIO_PIN_RESET);

	spwm_enableHalfBridges(0x0);

	HAL_Delay(1);
	HAL_GPIO_WritePin(PIN_DRVEN, GPIO_PIN_SET);
	HAL_Delay(1);

	HAL_GPIO_WritePin(PIN_ENA, GPIO_PIN_SET);
	HAL_GPIO_WritePin(PIN_ENB, GPIO_PIN_SET);
	HAL_GPIO_WritePin(PIN_ENC, GPIO_PIN_SET);

	spwm_enableHalfBridges(0x7);

	dbg_println("spwm_init() iSense ADC computed to take %u cycles (%.3f us)", ISENSE_SSAA_CPU_CYCLES, (double)(ISENSE_SSAA_CPU_CYCLES/170.0e0f));

	spwm_startRealtime();
}

/**
	@return the number of pwm cycles actually set in hardware
*/
uint16_t spwm_setDrvChannel(mctrl_pwmChannelId_t ch, float normValue)
{
	uint16_t pwmIn = normValue*(DRV_PWM_MAX);
	switch (ch)
	{
		case HTIM_DRV_CH_R:
		{
			uint16_t pwm = uclamp(pwmIn, DRV_PWM_BRK_MIN, DRV_PWM_BRK_MAX);
			__HAL_TIM_SET_COMPARE(HTIM_DRV, HTIM_DRV_CH_R, pwm);
			return pwm;
		}
		case HTIM_DRV_CH_A:
		case HTIM_DRV_CH_B:
		case HTIM_DRV_CH_C:
		{
			uint16_t pwm = uclamp(pwmIn, DRV_PWM_MOT_MIN, DRV_PWM_MOT_MAX);
			__HAL_TIM_SET_COMPARE(HTIM_DRV, ch, pwm);
			return pwm ;
		}
		default:
		{
			return 0;
		}
	}
}




